<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backbone Beginner Name List</title>
    <!-- Stylesheet(s) -->
    <link href="" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
      <![endif]-->
      <!-- Custom styles for this template -->
      <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.1.1/css/bootstrap.min.css">
  </head>
  <body>
      <div class="container">
        <h1>User Manager</h1>
        <hr />
        <div class="page"></div>
    </div>

<!--/* Call out for cloudflare repo */-->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.0/backbone-min.js"></script>
<script>
    <!--/* Create form input from jQuery into object */-->
        $.fn.serializeObject = function() { 
          var o = {};
          var a = this.serializeArray();
          $.each(a, function() {
              if (o[this.name] !== undefined) {
                  if (!o[this.name].push) {
                      o[this.name] = [o[this.name]];
                  }
                  o[this.name].push(this.value || '');
              } else {
                  o[this.name] = this.value || '';
              }
          });
          return o;
      };
</script>
<!-- /* This is the start of the table area */ -->
    <script type="text/template" id="user-list-template">
        <!--/* We use hash tags to create new links in Single Page Applications.
        Unless you are using push state. */-->
        <a href="#/new" class="btn btn-primary">New User</a> 
        <hr />
        <table class="table striped">
            <thead>
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Age</th>
                    <th></th>
                </tr>
            </thead>
            <tbody> <!--/* using underscore we are looping through our collection to create users. */-->
            <% _.each(users, function(user) { %>
                <tr>
                <!--/*This echo's out a block user - is a model and .get is backbone attribute. */-->
                    <td><%= user.get('firstname') %></td>
                    <td><%= user.get('lastname') %></td>
                    <td><%= user.get('age') %></td>
                    <td></td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </script>

<!--/* Define the Table for Create and Edit */-->
    <script type="text/template" id="edit-user-template">
        <form class="edit-user-form">
            <legend>Create User</legend>
            <label>First Name</label>
                <input type="text" name="firstname" />
            <label>Last Name</label>
                <input type="text" name="lastname" />
            <label>Age</label>
                <input type="text" name="age" />
        <hr />
        <button type="submit" class="btn">Create</button>
        </form>
    </script>

<!--/* Backbone.js functions */-->
    <script>
      $.ajaxPrefilter( function( options, originalOptions, jqXHR ) {
          options.url = 'http://backbonejs-beginner.herokuapp.com' + options.url;
      });

    var Users = Backbone.Collection.extend({
        url: '/users'
    });
    var User = Backbone.Model.extend({
        urlRoot: '/users'
    });

    var UserList = Backbone.View.extend ({
        el: '.page',
        render: function () {
            var that = this;
            var users = new Users();
            users.fetch({
                success: function (users) {
                    var template = _.template($('#user-list-template').html(), {users: users.models});
                    that.$el.html(template);
                }
            })
        }
    });
    
    var userList = new UserList();


    var EditUser = Backbone.View.extend ({
        el: '.page',
        render: function () {
            var template = _.template($('#edit-user-template').html(), {});
            this.$el.html(template);
        },
        events: {
            'submit .edit-user-form': 'saveUser'
        },
        saveUser: function (ev) {
            var userDetails = $(ev.currentTarget).serializeObject();
            var user = new User();
            user.save(userDetails, {
                success: function (user) {
                        router.navigate('', {trigger: true});
                }
            })
            return false;
        }
    });
    var editUser = new EditUser();


    var Router = Backbone.Router.extend ({
        routes: {
            '': 'home',
            'new': 'editUser'
        }
    });
    <!--/* Render user list */-->
    var router = new Router;
    router.on('route:home', function () {
        userList.render();  
    });
    router.on('route:editUser', function () {
        editUser.render();
    });

    Backbone.history.start();
  </script>

</body>
</html>
